name: Full Infra + App Deployment with SonarCloud scan

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  terraform:
    runs-on: windows-latest

    env:
      # Terraform authentication
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Terraform backend configuration
      TF_BACKEND_RESOURCE_GROUP: ${{ secrets.TF_BACKEND_RESOURCE_GROUP }}
      TF_BACKEND_STORAGE_ACCOUNT: ${{ secrets.TF_BACKEND_STORAGE_ACCOUNT }}
      TF_BACKEND_CONTAINER: ${{ secrets.TF_BACKEND_CONTAINER }}
      TF_BACKEND_KEY: ${{ secrets.TF_BACKEND_KEY }}

      # Deployment configuration
      RESOURCE_GROUP_NAME: ${{ secrets.RESOURCE_GROUP_NAME }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: latest

      # ðŸ”¹ Azure Login using Service Principal (v1)
      - name: Azure Login
        uses: azure/login@v1
        with:
          auth-type: SERVICE_PRINCIPAL       # Must be uppercase with underscore
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}

      # ðŸ”¹ Terraform Init
      - name: Terraform Init
        shell: pwsh
        run: |
          terraform init `
            -backend-config="resource_group_name=${{ env.TF_BACKEND_RESOURCE_GROUP }}" `
            -backend-config="storage_account_name=${{ env.TF_BACKEND_STORAGE_ACCOUNT }}" `
            -backend-config="container_name=${{ env.TF_BACKEND_CONTAINER }}" `
            -backend-config="key=${{ env.TF_BACKEND_KEY }}" `
            -backend-config="subscription_id=${{ env.ARM_SUBSCRIPTION_ID }}" `
            -backend-config="client_id=${{ env.ARM_CLIENT_ID }}" `
            -backend-config="client_secret=${{ env.ARM_CLIENT_SECRET }}" `
            -backend-config="tenant_id=${{ env.ARM_TENANT_ID }}"

      # ðŸ”¹ Terraform Plan
      - name: Terraform Plan
        shell: pwsh
        run: terraform plan -var subscription_id=${{ env.ARM_SUBSCRIPTION_ID }}

      # ðŸ”¹ Terraform Apply
      - name: Terraform Apply
        shell: pwsh
        run: terraform apply -var subscription_id=${{ env.ARM_SUBSCRIPTION_ID }} -auto-approve
